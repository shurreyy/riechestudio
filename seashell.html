<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Shell Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.csg.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script>
        // For each shell, this sketch generates a unique 3D cross-section, then extrudes the cross-section along a helical path.
        // Amazingly, such seemingly different shells all result from small variations in the cross-section and spiral path. 
        const e = 2.71828;
        let sections = 600;
        let section;
        let lpos, tlpos;
        let orbit, torbit;
        let swidth, sheight;
        let cutx, cuty, cutw, cuth;
        let orbits, ovel;
        let xstretch, ystretch, tilt, bend;
        let zoom = 1;
        let tzoom, ozoom;
        
        // Button variables
        let buttons = [];
        let button0, button1, button2, button3, button4, button5;

        function setup() {
            createCanvas(windowWidth, windowHeight, WEBGL);
            ozoom = height / 600;
            lpos = createVector(0, 0);
            tlpos = createVector(0, 0);
            orbit = createVector(0, 0);
            torbit = createVector(0, -HALF_PI);
            
            // Initialize shell parameters with default values
            swidth = 40;
            sheight = 40;
            cutx = -200;
            cuty = 0;
            cutw = 100;
            cuth = 150;
            orbits = 6;
            tilt = 0;
            bend = -PI / 9;
            xstretch = 1;
            ystretch = 0;
            ovel = 1;
            
            // Check if CSG library is loaded
            if (typeof csg !== 'undefined') {
                console.log('CSG library loaded successfully');
            } else {
                console.warn('CSG library not loaded. Some features may not work properly.');
            }
            
            makeHTML();
            chooseInitial();
            tzoom = ozoom;
        }

        function draw() {
            tlpos.x = mouseX - width / 2;
            tlpos.y = mouseY - height / 2;
            if (mouseIsPressed && mouseX > 150) {
                torbit.x += movedX / 100;
                torbit.y -= movedY / 200;
            }
            lpos.lerp(tlpos, 0.05);
            orbit.lerp(torbit, 0.1);
            zoom = lerp(zoom, tzoom, 0.1);
            background(0);
            ambientLight(100);
            pointLight(122, 61, 67, 2 * lpos.x, lpos.y / 2, lpos.y);
            // pointLight(160,82,45, 2 * lpos.x, lpos.y / 2, lpos.y);
            // pointLight(50,75,118, 2 * lpos.x, lpos.y / 2, lpos.y);
            noStroke();
            specularMaterial(255);
            drawPreview();
            
            if (!section) return; // Don't continue if section is not initialized
            
            scale(zoom);
            rotateY(orbit.x);
            rotateX(orbit.y);
            rotateY(4 * PI / 3);
            let a = 0;
            let C = 1;
            let y = -200 * ystretch;
            let layers = min(frameCount * 5, sections);
            for (let i = 0; i < layers; i++) {
                let a = map(i, 0, sections, 0, 8 * TAU);
                let r = C * (e ** (a * (1 / tan(PI / 2.13)))); //Natural log magic!
                y += ystretch * r / (sections / orbits);
                push();
                translate(0, ystretch * y, 0);
                rotateY(-ovel * a + HALF_PI);
                rotateZ(tilt);
                translate(xstretch * r, 0, 0);
                rotateY(bend);
                scale(map(r, 0, 120, 0, 1.5));
                rotateY(PI);
                model(section);
                pop();
            }
        }

        function drawPreview() {
            if (!section) return; // Don't draw if section is not initialized
            
            push();
            translate(-width / 2 + 75, height / 2 - (sheight + 50), 0);
            rotateY(frameCount / 60);
            model(section);
            pop();
        }

        function keyPressed() {
            if (keyCode == 32) restoreTilt();
        }

        function restoreTilt() {
            torbit.x = 0;
            torbit.y = -HALF_PI;
            tzoom = ozoom;
            setTimeout(tiltBack, 2500);
        }

        function mouseWheel(event) {
            tzoom += event.delta / 100;
        }

        function tiltBack() {
            torbit.y = PI / 12;
        }

        function chooseInitial() {
            let pick = floor(random(buttons.length));
            switch (pick) {
                case 0:
                    drawClam();
                    break;
                case 1:
                    drawNautilus();
                    break;
                case 2:
                    drawOlive();
                    break;
                case 3:
                    drawPeriwinkle();
                    break;
                case 4:
                    drawTurritella();
                    break;
                case 5:
                    drawWhelk();
                    break;
            }
        }

        // This function creates the cross section, starting with an ellipsoid and then slicing different
        // segments from it, using the subtract() function in the CSG library. 
        // (A preview of the cross-section appears in the lower-left corner of the screen.)
        function makeSection() {
            // Check if CSG library is available
            if (typeof csg === 'undefined') {
                console.error('CSG library not loaded. Please check the p5.csg.min.js script.');
                // Fallback to a simple ellipsoid
                return () => ellipsoid(swidth, sheight, swidth, 36, 36);
            }
            
            let BooleanOptions = {
                includeSelfFaces: true,
                includeOtherFaces: false
            };
            fill(255, 50);
            noStroke();
            let section = csg(() => ellipsoid(swidth, sheight, swidth,36,36))
                .subtract(() => {
                    push();
                    translate(cutx, -120 - cuty, 0);
                    rotateZ(QUARTER_PI);
                    ellipsoid(cutw, cuth, 100);
                    pop();
                })
                .subtract(() => {
                    push();
                    translate(0, 0, -55);
                    rotateY(-PI / 24);
                    box(400, 400, 100);
                    pop();
                }, BooleanOptions)
                .subtract(() => {
                    push();
                    translate(0, 0, 55);
                    box(400, 400, 100);
                    pop();
                }, BooleanOptions)
                .done();
            return section;
        }

        // Each button sets a few values to determine the shape of the cross-section and the spiral.
        function makeHTML() {
            button0 = createButton('Clam');
            button0.style('width', '100px');
            button0.style('background-color', 'rgba(255,255,255,0.1)');
            button0.style('color', 'white');
            button0.position(10, 10);
            button0.mousePressed(drawClam);
            button1 = createButton('Nautilus');
            button1.position(10, 40);
            button1.mousePressed(drawNautilus);
            button2 = createButton('Olive');
            button2.position(10, 70);
            button2.mousePressed(drawOlive);
            button3 = createButton('Periwinkle');
            button3.position(10, 100);
            button3.mousePressed(drawPeriwinkle);
            button4 = createButton('Turritella');
            button4.position(10, 130);
            button4.mousePressed(drawTurritella);
            button5 = createButton('Whelk');
            button5.position(10, 160);
            button5.mousePressed(drawWhelk);
            buttons = [button0, button1, button2, button3, button4, button5];
            for (let b of buttons) {
                b.style('width', '100px');
                b.style('background-color', 'rgba(255,255,255,0.1)');
                b.style('color', 'white');
            }
        }

        function drawNautilus() {
            highlightButton(button1);
            restoreTilt();
            frameCount = 0;
            sections = 600;
            swidth = 40;
            sheight = 40;
            cutx = -200;
            cuty = 0;
            cutw = 100;
            cuth = 150;
            orbits = 6;
            tilt = 0;
            bend = -PI / 9;
            xstretch = 1;
            ystretch = 0;
            ovel = 1;
            section = makeSection();
        }

        function drawClam() {
            highlightButton(button0);
            restoreTilt();
            frameCount = 0;
            sections = 300;
            swidth = 70;
            sheight = 100;
            cutx = -500;
            cuty = -500;
            cutw = 100;
            cuth = 150;
            orbits = 8;
            tilt = 0;
            bend = PI / 12;
            xstretch = 0.8;
            ystretch = 0.4;
            ovel = 0.12;
            section = makeSection();
        }

        function drawOlive() {
            highlightButton(button2);
            restoreTilt();
            frameCount = 0;
            sections = 600;
            swidth = 30;
            sheight = 120;
            cutx = 0;
            cuty = 90;
            cutw = 100;
            cuth = 150;
            orbits = 8;
            tilt = PI / 18;
            bend = 0;
            xstretch = 0.35;
            ystretch = 0.92;
            ovel = 1;
            section = makeSection();
        }

        function drawPeriwinkle() {
            highlightButton(button3);
            restoreTilt();
            frameCount = 0;
            sections = 600;
            swidth = 50;
            sheight = 55;
            cutx = -200;
            cuty = 0;
            cutw = 100;
            cuth = 150;
            orbits = 6;
            tilt = PI / 3;
            bend = 0;
            xstretch = 0.75;
            ystretch = 0.5;
            ovel = 1;
            section = makeSection();
        }

        function drawTurritella() {
            highlightButton(button4);
            restoreTilt();
            frameCount = 0;
            sections = 600;
            swidth = 20;
            sheight = 25;
            cutx = -200;
            cuty = 0;
            cutw = 100;
            cuth = 150;
            orbits = 16;
            tilt = -PI / 24;
            bend = 0;
            xstretch = 0.3;
            ystretch = 0.9;
            ovel = 3;
            section = makeSection();
        }

        function drawWhelk() {
            highlightButton(button5);
            restoreTilt();
            frameCount = 0;
            sections = 600;
            swidth = 50;
            sheight = 120;
            cutx = 30;
            cuty = 80;
            cutw = 100;
            cuth = 150;
            orbits = 8;
            tilt = PI / 12;
            bend = 0;
            xstretch = 0.55;
            ystretch = 1;
            ovel = 1;
            section = makeSection();
        }

        function highlightButton(button) {
            for (let b of buttons) {
                b.style('background-color', 'rgba(255,255,255,0.1)');
            }
            button.style('background-color', 'rgba(255,255,255,0.5)');
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            ozoom = height / 600;
        }
    </script>
</body>
</html>